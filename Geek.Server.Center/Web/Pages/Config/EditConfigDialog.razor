@using System.Net
@using System.Text

@inject ISnackbar Snackbar

<MudDialog DisableSidePadding="true" Style="min-width:1000px;">
    <DialogContent>
        <MudContainer Style="max-height: 700px; overflow-y: scroll">
            <MudTextField @bind-Value="@describe" MaxLength="@describeMaxLen" Counter="@describeMaxLen" Label="说明" Variant="Variant.Outlined" Immediate="true" />
            <MudTextField T="string" Label="配置" Variant="Variant.Outlined" @bind-Value="@content" Lines="25" Style="margin-top: 3px;font-size:0.75rem;line-height: 1.4; font-weight: 400;" />
        </MudContainer>

    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@(()=>CheckJson())">json检查</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Ok">完成</MudButton>
    </DialogActions>
</MudDialog>


@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    [Parameter] public ConfigInfo cfgItem { get; set; }

    int cfgIdMaxLen = 25;
    int describeMaxLen = 50;
    private string cfgId;
    private string describe;
    private string content;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override void OnParametersSet()
    {
        describe = cfgItem.Describe;
        content = cfgItem.Data;
    }

    private void Ok()
    {
        if (!CheckJson(false))
            return;
        cfgItem.Describe = describe;
        cfgItem.Data = content;
        MudDialog.Close(DialogResult.Ok(true));
    }
    private void Cancel()
    {
        MudDialog.Close(DialogResult.Cancel());
    }

    private bool CheckJson(bool showSuccessTips = true)
    {
        Snackbar.Clear();
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopCenter;
        if (Utils.CheckJson(content))
        {
            if (showSuccessTips)
                Snackbar.Add("json格式正确", Severity.Success);
            return true;
        }
        else
        {
            Snackbar.Add("json格式错误", Severity.Error);
            return false;
        }
    }
}
